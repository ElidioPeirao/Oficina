<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal do Cliente</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-dark: #121224;
            --bg-light-dark: #1a1a2e;
            --primary: #0f3460;
            --accent: #e94560;
            --text-light: #f0f0f0;
            --text-muted: #a0a0b0;
            --orange-highlight: #ff6700;
            --green-success: #00b894;
            --yellow-warning: #f1c40f;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text-light); }
        .hidden { display: none !important; }
        .auth-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .auth-form { background-color: var(--bg-light-dark); padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 100%; max-width: 400px; text-align: center; border-top: 4px solid var(--orange-highlight); }
        .auth-form h2 { margin-bottom: 25px; }
        .input-group { margin-bottom: 20px; }
        .input-group input { width: 100%; padding: 12px 15px; background-color: var(--bg-dark); border: 1px solid var(--primary); border-radius: 8px; color: var(--text-light); font-size: 16px; }
        .auth-btn { width: 100%; padding: 12px; background-color: var(--orange-highlight); border: none; border-radius: 8px; color: #fff; font-size: 16px; font-weight: bold; cursor: pointer; }
        #auth-error { color: var(--accent); margin-top: 15px; min-height: 20px; }
        #main-app-portal header { background-color: var(--bg-light-dark); padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--primary); }
        #main-app-portal header h2 { font-size: 24px; }
        #main-app-portal header #client-name { color: var(--orange-highlight); }
        #logout-btn-portal { background: none; border: none; color: var(--text-muted); font-size: 16px; cursor: pointer; }
        .portal-container { padding: 40px; }
        .item-card { background-color: var(--bg-light-dark); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid var(--orange-highlight); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .item-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .item-card h3 { margin-bottom: 10px; }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; }
        .modal-content { background-color: var(--bg-light-dark); margin: auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 800px; position: relative; }
        .close-btn { color: #aaa; position: absolute; top: 15px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .detail-item strong { display: block; color: var(--text-muted); font-size: 14px; }
        .detail-item span { font-size: 18px; }
        .progress-bar-background { width: 100%; background-color: var(--bg-dark); border-radius: 20px; height: 20px; overflow: hidden; border: 1px solid var(--primary); }
        .progress-bar-fill { height: 100%; background-color: var(--green-success); border-radius: 20px; transition: width 0.5s; }
        ul { list-style: none; padding-left: 0; }
        #projeto-detalhes-content ul li, #servicos-veiculo-list ul li { padding: 5px; }
        .objetivo-texto.concluido { text-decoration: line-through; color: var(--text-muted); }
        .checklist-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .checklist-item { display: flex; align-items: center; gap: 10px; }
        .status-badge { padding: 5px 10px; border-radius: 15px; font-weight: bold; font-size: 12px; text-transform: uppercase; }
        .status-orcamento { background-color: var(--yellow-warning); color: var(--bg-dark); }
        .status-aprovada { background-color: var(--green-success); color: #fff; }
        .status-paga { background-color: var(--primary); color: #fff; }

        /* File Browser Styles */
        .file-browser-container { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; }
        .file-item, .folder-item { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 120px; height: 120px; background-color: var(--bg-dark); border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; transition: background-color 0.2s; }
        .file-item:hover, .folder-item:hover { background-color: var(--primary); }
        .file-item i, .folder-item i { font-size: 40px; margin-bottom: 10px; color: var(--orange-highlight); }
        .file-item span, .folder-item span { font-size: 14px; word-break: break-word; }
        .breadcrumb { margin-bottom: 15px; }
        .breadcrumb span { cursor: pointer; color: var(--text-muted); }
        .breadcrumb span:hover { color: var(--text-light); }
        .breadcrumb span:last-child { color: var(--orange-highlight); cursor: default; }

    </style>
</head>
<body>

    <div id="login-view" class="auth-container">
        <div class="auth-form">
            <img src="https://i.imgur.com/31xgQbN.png" alt="Logo da Empresa" style="max-width: 150px; margin-bottom: 20px;">
            <h2><i class="fas fa-user-circle"></i> Portal do Cliente</h2>
            <form id="login-form-portal">
                <div class="input-group">
                    <input type="text" id="login-cpf" placeholder="Digite seu CPF" required>
                </div>
                <button type="submit" class="auth-btn">Acessar</button>
            </form>
            <p id="auth-error"></p>
        </div>
    </div>

    <div id="main-app-portal" class="hidden">
        <header>
            <h2>Bem-vindo, <span id="client-name"></span>!</h2>
            <button id="logout-btn-portal"><i class="fas fa-sign-out-alt"></i> Sair</button>
        </header>
        <main class="portal-container">
            <section id="automotivo-portal" class="hidden">
                <h3><i class="fas fa-car"></i> Meus Veículos</h3>
                <div id="veiculos-list"></div>
            </section>
            <hr id="hr-automotivo-industrial" class="hidden" style="border-color: var(--primary); margin: 40px 0;">
            <section id="industrial-portal" class="hidden">
                <h3><i class="fas fa-industry"></i> Meus Projetos</h3>
                <div id="projetos-list"></div>
            </section>
            <hr id="hr-industrial-notas" class="hidden" style="border-color: var(--primary); margin: 40px 0;">
            <section id="notas-portal" class="hidden">
                <h3><i class="fas fa-file-invoice"></i> Minhas Notas e Orçamentos</h3>
                <div id="notas-list"></div>
            </section>
        </main>
    </div>

    <!-- Modais para Detalhes -->
    <div id="veiculo-detalhes-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 id="veiculo-detalhe-titulo-modal"></h3>
            <div id="veiculo-detalhes-content"></div>
        </div>
    </div>

    <div id="projeto-detalhes-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 id="projeto-detalhe-titulo-modal"></h3>
            <div id="projeto-detalhes-content"></div>
        </div>
    </div>
    
    <div id="checklist-detalhes-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 id="checklist-detalhe-titulo-modal">Detalhes do Checklist</h3>
            <div id="checklist-detalhes-content"></div>
        </div>
    </div>
    
    <div id="nota-detalhes-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3>Detalhes da Nota</h3>
            <div id="nota-detalhes-content"></div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, getDocs, query, where, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBCoUHQ0SwXH5QZgm35gWCtcPdAZPl3Xvw",
            authDomain: "garagem-da686.firebaseapp.com",
            projectId: "garagem-da686",
            storageBucket: "garagem-da686.firebasestorage.app",
            messagingSenderId: "794405215347",
            appId: "1:794405215347:web:dbe210d32475faf385de06"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const loginView = document.getElementById('login-view');
        const mainApp = document.getElementById('main-app-portal');
        
        let currentProjectData = {};
        let portalPath = {
            documentos: [],
            projetos3d: []
        };
        
        // --- LÓGICA DE LOGIN/SESSÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            const clientData = sessionStorage.getItem('clientData');
            if (clientData) {
                const data = JSON.parse(clientData);
                showDashboard(data.userId, data.clienteId);
            }
        });

        document.getElementById('login-form-portal').addEventListener('submit', async (e) => {
            e.preventDefault();
            const cpf = document.getElementById('login-cpf').value.replace(/\D/g, '');
            const errorP = document.getElementById('auth-error');
            errorP.textContent = '';

            try {
                const indexRef = doc(db, 'client_index', cpf);
                const indexSnap = await getDoc(indexRef);

                if (indexSnap.exists()) {
                    const { userId, clienteId } = indexSnap.data();
                    const clientData = { userId, clienteId };
                    sessionStorage.setItem('clientData', JSON.stringify(clientData));
                    showDashboard(userId, clienteId);
                } else {
                    errorP.textContent = 'CPF não encontrado.';
                }
            } catch (error) {
                console.error("Erro no login:", error);
                errorP.textContent = 'Ocorreu um erro ao tentar fazer login.';
            }
        });

        document.getElementById('logout-btn-portal').addEventListener('click', () => {
            sessionStorage.removeItem('clientData');
            loginView.classList.remove('hidden');
            mainApp.classList.add('hidden');
        });

        // --- EXIBIÇÃO DO DASHBOARD E DADOS ---
        async function showDashboard(userId, clienteId) {
            const clienteDoc = await getDoc(doc(db, `users/${userId}/clientes`, clienteId));
            if (!clienteDoc.exists()) return;

            const cliente = clienteDoc.data();
            document.getElementById('client-name').textContent = cliente.nome.split(' ')[0];
            
            loginView.classList.add('hidden');
            mainApp.classList.remove('hidden');

            loadVeiculos(userId, clienteId);
            loadProjetos(userId, clienteId);
            loadNotas(userId, clienteId);
        }

        function loadVeiculos(userId, clienteId) {
            const q = query(collection(db, `users/${userId}/veiculos`), where("proprietarioId", "==", clienteId));
            const section = document.getElementById('automotivo-portal');
            const hr = document.getElementById('hr-automotivo-industrial');

            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('veiculos-list');
                list.innerHTML = '';
                if (snapshot.empty) {
                    section.classList.add('hidden');
                    hr.classList.add('hidden');
                    return;
                }
                section.classList.remove('hidden');
                
                const hasIndustrial = !document.getElementById('industrial-portal').classList.contains('hidden');
                const hasNotas = !document.getElementById('notas-portal').classList.contains('hidden');
                if(hasIndustrial || hasNotas) {
                    hr.classList.remove('hidden');
                }


                snapshot.forEach(doc => {
                    const veiculo = doc.data();
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.innerHTML = `<h3>${veiculo.marca} ${veiculo.modelo} - ${veiculo.placa}</h3><p>Status: <strong>${veiculo.status}</strong></p>`;
                    card.addEventListener('click', () => showVeiculoDetails(userId, doc.id));
                    list.appendChild(card);
                });
            });
        }
        
        function loadProjetos(userId, clienteId) {
            const q = query(collection(db, `users/${userId}/projetos`), where("clienteId", "==", clienteId));
            const section = document.getElementById('industrial-portal');
            const hrAutomotivo = document.getElementById('hr-automotivo-industrial');
            const hrNotas = document.getElementById('hr-industrial-notas');

            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('projetos-list');
                list.innerHTML = '';
                 if (snapshot.empty) {
                    section.classList.add('hidden');
                    hrAutomotivo.classList.add('hidden');
                    hrNotas.classList.add('hidden');
                    return;
                }
                section.classList.remove('hidden');
                
                const hasAutomotivo = !document.getElementById('automotivo-portal').classList.contains('hidden');
                if(hasAutomotivo) hrAutomotivo.classList.remove('hidden');

                const hasNotas = !document.getElementById('notas-portal').classList.contains('hidden');
                if(hasNotas) hrNotas.classList.remove('hidden');

                snapshot.forEach(doc => {
                    const projeto = doc.data();
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.innerHTML = `<h3>${projeto.nome}</h3><p>Status: <strong>${projeto.status}</strong></p><p>Valor: <strong>R$ ${projeto.valor.toFixed(2)}</strong></p>`;
                    card.addEventListener('click', () => showProjetoDetails(userId, doc.id));
                    list.appendChild(card);
                });
            });
        }
        
        function loadNotas(userId, clienteId) {
            const q = query(collection(db, `users/${userId}/notas`), where("clienteId", "==", clienteId));
            const section = document.getElementById('notas-portal');
            const hr = document.getElementById('hr-industrial-notas');

            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('notas-list');
                list.innerHTML = '';
                if(snapshot.empty) {
                    section.classList.add('hidden');
                    hr.classList.add('hidden');
                    return;
                }
                section.classList.remove('hidden');
                const hasIndustrial = !document.getElementById('industrial-portal').classList.contains('hidden');
                if(hasIndustrial) hr.classList.remove('hidden');


                snapshot.forEach(doc => {
                    const nota = doc.data();
                    const card = document.createElement('div');
                    card.className = 'item-card';

                    const statusClassMap = { 'Orçamento': 'status-orcamento', 'Aprovada': 'status-aprovada', 'Paga': 'status-paga' };
                    const statusClass = statusClassMap[nota.status] || '';

                    let actionsHTML = '';
                    if (nota.status === 'Orçamento') {
                        actionsHTML = `<button class="auth-btn" style="margin-top: 15px; width: auto; padding: 8px 15px;" onclick="window.approveOrcamento(event, '${userId}', '${doc.id}')">Aprovar Orçamento</button>`;
                    }

                    card.innerHTML = `
                        <h3>Nota/Orçamento - ${new Date(nota.createdAt.seconds*1000).toLocaleDateString()}</h3>
                        <p>Veículo: <strong>${nota.veiculoInfo.placa}</strong></p>
                        <p>Valor: <strong>R$ ${nota.valorTotal.toFixed(2)}</strong></p>
                        <p>Status: <span class="status-badge ${statusClass}">${nota.status}</span></p>
                        ${actionsHTML}
                    `;
                    card.addEventListener('click', (e) => {
                        if (e.target.tagName !== 'BUTTON') {
                            showNotaDetails(userId, doc.id);
                        }
                    });
                    list.appendChild(card);
                });
            });
        }


        // --- MODAIS DE DETALHES ---
        async function showVeiculoDetails(userId, veiculoId){
            const veiculo = (await getDoc(doc(db, `users/${userId}/veiculos`, veiculoId))).data();
            
            document.getElementById('veiculo-detalhe-titulo-modal').textContent = `Detalhes de ${veiculo.marca} ${veiculo.modelo}`;
            const contentDiv = document.getElementById('veiculo-detalhes-content');
            contentDiv.innerHTML = `
                <div class="details-grid">
                    <div class="detail-item"><strong>Placa</strong><span>${veiculo.placa}</span></div>
                    <div class="detail-item"><strong>Ano</strong><span>${veiculo.ano}</span></div>
                    <div class="detail-item"><strong>KM</strong><span>${veiculo.quilometragem.toLocaleString('pt-BR')}</span></div>
                    <div class="detail-item"><strong>Status</strong><span>${veiculo.status}</span></div>
                </div>
                <h4>Serviços Realizados</h4>
                <div id="servicos-veiculo-list">Carregando...</div>
                <br>
                <h4>Checklists de Entrada</h4>
                <div id="checklists-veiculo-list">Carregando...</div>
            `;
            openModal('veiculo-detalhes-modal');

            // Load services
            const servicosQuery = query(collection(db, `users/${userId}/veiculos/${veiculoId}/servicos`));
            onSnapshot(servicosQuery, (snap) => {
                const list = document.getElementById('servicos-veiculo-list');
                list.innerHTML = '';
                if(snap.empty) { list.innerHTML = '<p>Nenhum serviço registrado.</p>'; return;}
                snap.forEach(servicoDoc => {
                    const servico = servicoDoc.data();
                    list.innerHTML += `<div class="item-card" style="cursor:default;"><strong>${new Date(servico.createdAt.seconds*1000).toLocaleDateString()}:</strong> ${servico.descricao}</div>`;
                });
            });
             // Load checklists
            const checklistsQuery = query(collection(db, `users/${userId}/veiculos/${veiculoId}/checklists`));
            onSnapshot(checklistsQuery, (snap) => {
                const list = document.getElementById('checklists-veiculo-list');
                list.innerHTML = '';
                if(snap.empty) { list.innerHTML = '<p>Nenhum checklist registrado.</p>'; return;}
                snap.forEach(checklistDoc => {
                    const checklist = checklistDoc.data();
                    const checklistCard = document.createElement('div');
                    checklistCard.className = 'item-card';
                    checklistCard.innerHTML = `<strong>${new Date(checklist.createdAt.seconds*1000).toLocaleString('pt-BR')}</strong>`;
                    checklistCard.addEventListener('click', () => showChecklistDetails(userId, veiculoId, checklistDoc.id));
                    list.appendChild(checklistCard);
                });
            });
        }
        
        async function showProjetoDetails(userId, projetoId){
            const projetoRef = doc(db, `users/${userId}/projetos`, projetoId);
            onSnapshot(projetoRef, (docSnap) => {
                if (!docSnap.exists()) {
                    console.error("Projeto não encontrado");
                    return;
                }
                currentProjectData = docSnap.data();

                document.getElementById('projeto-detalhe-titulo-modal').textContent = `Detalhes de ${currentProjectData.nome}`;
                const contentDiv = document.getElementById('projeto-detalhes-content');
                
                let objetivosHTML = '<p>Nenhum objetivo definido.</p>';
                if(currentProjectData.objetivos && currentProjectData.objetivos.length > 0) {
                    const concluidos = currentProjectData.objetivos.filter(o => o.concluido).length;
                    const total = currentProjectData.objetivos.length;
                    const porcentagem = total > 0 ? (concluidos / total) * 100 : 0;
                    
                    objetivosHTML = `
                        <div class="progress-bar-background" style="margin-bottom: 10px;">
                            <div class="progress-bar-fill" style="width: ${porcentagem}%;"></div>
                        </div>
                        <ul>
                            ${currentProjectData.objetivos.map(o => `<li class="${o.concluido ? 'objetivo-texto concluido' : 'objetivo-texto'}"><i class="fas ${o.concluido ? 'fa-check-circle' : 'fa-circle'}"></i> ${o.nome}</li>`).join('')}
                        </ul>
                    `;
                }

                // Lógica para renderizar seções de arquivos apenas se houver conteúdo visível
                let documentosHTML = '';
                const documentosVisiveis = (currentProjectData.documentos || []).filter(doc => doc.visivelParaCliente);
                if (documentosVisiveis.length > 0) {
                    documentosHTML = `
                        <hr style="border-color: var(--primary); margin: 20px 0;">
                        <h4>Documentos</h4>
                        <div class="breadcrumb" id="portal-breadcrumb-documentos"></div>
                        <div class="file-browser-container" id="portal-documentos-browser"></div>
                    `;
                }

                let projetos3dHTML = '';
                const projetos3dVisiveis = (currentProjectData.projetos3d || []).filter(proj => proj.visivelParaCliente);
                if (projetos3dVisiveis.length > 0) {
                     projetos3dHTML = `
                        <hr style="border-color: var(--primary); margin: 20px 0;">
                        <h4>Projetos 3D</h4>
                        <div class="breadcrumb" id="portal-breadcrumb-projetos3d"></div>
                        <div class="file-browser-container" id="portal-projetos3d-browser"></div>
                    `;
                }


                contentDiv.innerHTML = `
                    <div class="details-grid">
                        <div class="detail-item"><strong>Status</strong><span>${currentProjectData.status}</span></div>
                        <div class="detail-item"><strong>Prazo</strong><span>${new Date(currentProjectData.prazo.seconds * 1000).toLocaleDateString()}</span></div>
                    </div>
                    <h4>Progresso</h4>
                    ${objetivosHTML}
                    ${documentosHTML}
                    ${projetos3dHTML}
                `;

                if (documentosVisiveis.length > 0) {
                    portalPath.documentos = [{ id: 'root', nome: 'Início' }];
                    renderClientFileBrowser('documentos');
                }
                if (projetos3dVisiveis.length > 0) {
                    portalPath.projetos3d = [{ id: 'root', nome: 'Início' }];
                    renderClientFileBrowser('projetos3d');
                }
            });

             openModal('projeto-detalhes-modal');
        }

        function renderClientFileBrowser(type) {
            const allItems = currentProjectData[type] || [];
            const browserId = `portal-${type}-browser`;
            const breadcrumbId = `portal-breadcrumb-${type}`;
            const container = document.getElementById(browserId);
            const breadcrumbContainer = document.getElementById(breadcrumbId);
            
            if (!container || !breadcrumbContainer) return;

            const currentPath = portalPath[type];
            const currentParentId = currentPath[currentPath.length - 1].id;

            // Render Breadcrumb
            if (currentPath.length > 1) {
                breadcrumbContainer.innerHTML = currentPath.map((p, i) => `<span class="breadcrumb-item" data-index="${i}">${p.nome}</span>`).join(' > ');
                breadcrumbContainer.querySelectorAll('.breadcrumb-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        portalPath[type].splice(index + 1);
                        renderClientFileBrowser(type);
                    });
                });
            } else {
                breadcrumbContainer.innerHTML = '';
            }

            container.innerHTML = '';
            
            const itemsInCurrentDir = allItems.filter(item => {
                if (currentParentId === 'root') {
                    return item.parentId === 'root' || item.parentId == null; 
                }
                return item.parentId === currentParentId;
            });

            // Render folders
            itemsInCurrentDir.filter(item => item.type === 'folder' && item.visivelParaCliente).forEach(folder => {
                const folderDiv = document.createElement('div');
                folderDiv.className = 'folder-item';
                folderDiv.innerHTML = `<i class="fas fa-folder"></i><span>${folder.nome}</span>`;
                folderDiv.addEventListener('click', () => {
                    portalPath[type].push({ id: folder.id, nome: folder.nome });
                    renderClientFileBrowser(type);
                });
                container.appendChild(folderDiv);
            });

            // Render files
            itemsInCurrentDir.filter(item => item.type !== 'folder' && item.visivelParaCliente === true).forEach(file => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'file-item';
                fileDiv.innerHTML = `<i class="fas fa-file-alt"></i><span>${file.nome}</span>`;
                fileDiv.addEventListener('click', () => {
                    window.open(file.url, '_blank');
                });
                container.appendChild(fileDiv);
            });
        }


        async function showChecklistDetails(userId, veiculoId, checklistId) {
            const checklistRef = doc(db, `users/${userId}/veiculos/${veiculoId}/checklists`, checklistId);
            const checklistSnap = await getDoc(checklistRef);
            if (!checklistSnap.exists()) {
                alert("Checklist não encontrado.");
                return;
            }
            const checklist = checklistSnap.data();

            document.getElementById('checklist-detalhe-titulo-modal').textContent = `Checklist de ${new Date(checklist.createdAt.seconds * 1000).toLocaleDateString()}`;
            const contentDiv = document.getElementById('checklist-detalhes-content');

            const externalItems = ['farois', 'lanternas', 'retrovisores', 'pneus', 'vidros'];
            const internalItems = ['radio', 'tapetes', 'extintor', 'macaco', 'triangulo'];

            let externalItemsHTML = '';
            externalItems.forEach(key => {
                if (checklist.itens.hasOwnProperty(key)) {
                    const label = key.charAt(0).toUpperCase() + key.slice(1);
                    externalItemsHTML += `<div class="checklist-item"><input type="checkbox" ${checklist.itens[key] ? 'checked' : ''} disabled> <label>${label}</label></div>`;
                }
            });

            let internalItemsHTML = '';
            internalItems.forEach(key => {
                if (checklist.itens.hasOwnProperty(key)) {
                    const label = key.charAt(0).toUpperCase() + key.slice(1);
                    internalItemsHTML += `<div class="checklist-item"><input type="checkbox" ${checklist.itens[key] ? 'checked' : ''} disabled> <label>${label}</label></div>`;
                }
            });

            contentDiv.innerHTML = `
                <h4>Itens Externos</h4>
                <div class="checklist-grid">${externalItemsHTML}</div>
                <div class="detail-item"><strong>Avarias (Externo):</strong> <span>${checklist.avarias || 'Nenhuma'}</span></div>
                <hr style="border-color: var(--primary); margin: 20px 0;">
                <h4>Itens Internos</h4>
                <div class="checklist-grid">${internalItemsHTML}</div>
                <div class="detail-item"><strong>Observações (Interno):</strong> <span>${checklist.obsInternas || 'Nenhuma'}</span></div>
                <hr style="border-color: var(--primary); margin: 20px 0;">
                <div class="details-grid">
                    <div class="detail-item"><strong>Combustível:</strong> <span>${checklist.combustivel}%</span></div>
                </div>
                <hr style="border-color: var(--primary); margin: 20px 0;">
                <h4>Assinatura do Cliente</h4>
                <img src="${checklist.assinatura}" style="background-color: white; border-radius: 8px; max-width: 400px; height: auto;" />
            `;
            openModal('checklist-detalhes-modal');
        }

        async function showNotaDetails(userId, notaId) {
            const notaRef = doc(db, `users/${userId}/notas`, notaId);
            const notaSnap = await getDoc(notaRef);
            if (!notaSnap.exists()) return;
            const nota = notaSnap.data();
            
            let servicosHTML = '';
            nota.servicos.forEach(servico => {
                servicosHTML += `
                    <div style="border: 1px solid var(--primary); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <strong>Serviço: ${servico.descricao}</strong>
                        <p>Mão de Obra: R$ ${servico.valorMaoDeObra.toFixed(2)}</p>
                        <p>Total Peças: R$ ${servico.valorPecas.toFixed(2)}</p>
                        <p><strong>Subtotal: R$ ${servico.valorTotal.toFixed(2)}</strong></p>
                    </div>
                `;
            });

            const contentDiv = document.getElementById('nota-detalhes-content');
            contentDiv.innerHTML = `
                 <div class="details-grid">
                    <div class="detail-item"><strong>Veículo</strong><span>${nota.veiculoInfo.modelo} (${nota.veiculoInfo.placa})</span></div>
                    <div class="detail-item"><strong>Valor Total</strong><span>R$ ${nota.valorTotal.toFixed(2)}</span></div>
                </div>
                <h4>Serviços Inclusos</h4>
                ${servicosHTML}
            `;
            openModal('nota-detalhes-modal');
        }
        
        window.approveOrcamento = async (event, userId, notaId) => {
            event.stopPropagation();
            try {
                const notaRef = doc(db, `users/${userId}/notas`, notaId);
                await updateDoc(notaRef, { status: "Aprovada" });
                // A UI atualizará automaticamente via onSnapshot.
            } catch (error) {
                console.error("Erro ao aprovar orçamento:", error);
            }
        };

        // --- Lógica de Modal Genérica ---
        document.querySelectorAll('.modal .close-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.target.closest('.modal').classList.add('hidden');
            });
        });

        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }
    </script>
</body>
</html>

